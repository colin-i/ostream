
#name: appimage

on:
 # Triggers the workflow on push or pull request events but only for the main branch
 #push:
 # branches: [ main ]
 #pull_request:
 # branches: [ main ]
 # Allows you to run this workflow manually from the Actions tab
 workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
 # This workflow contains a single job called "build"
 build:
  # The type of runner that the job will run on
  runs-on: ubuntu-18.04
  # Steps represent a sequence of tasks that will be executed as part of the job
  steps:
   # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
   #- uses: actions/checkout@v3
   #with:
   # repository: colin-i/irc
   # path: my-tools
   #- uses: dsaltares/fetch-gh-release-asset@master
   #this is locally: throw new Error("Parameter token or opts.auth is required");
   #  with:
   #   repo: 'colin-i/test'
   #   file: 'ovideo.png'
   #   target: 'in/' #plague-linux.zip'
   # #version: 'tags/1.1'
   # #token: ${{ secrets.PAT }}
   #Runs a set of commands using the runners shell
   - name: Run a multi-line script
     run: |
      if [ -n "${{ env.init }}" ]; then
       exit
      fi
      mkdir -p in #p for multiple times
      cd in
      wget https://github.com/colin-i/test/releases/download/1.1/ovideo.png -O ovideo.png #O for multiple times
      cat > ovideo.desktop <<EOF
      [Desktop Entry]
      Type=Application
      Name=OVideo
      Exec=ovideo
      Icon=ovideo
      Categories=GNOME;GTK;
      EOF
      cat > ovideo.yml <<EOF
      app:
       ovideo
      script:
       - mv ../ovideo.png .
       - mv ../ovideo.desktop .
      EOF
      file=/squashfs-root/AppRun
      if [ ! -e "${file}" ]; then
       urlpart=`wget -q https://github.com/AppImage/pkg2appimage/releases -O - | grep "pkg2appimage-.*-x86_64.AppImage" | head -n 1 | cut -d '"' -f 2`
       wget -c https://github.com/${urlpart}
       #chmod +x ./pkg2appimage-*.AppImage
       file=`echo ./${urlpart} | cut -d '/' -f 7`
       chmod +x ${file}
       ./${file} --appimage-extract #modprobe not found,fuse not found
       file=./squashfs-root/AppRun
      fi
      wget https://ppa.launchpadcontent.net/colin-i/ppa/ubuntu/dists/bionic/main/binary-i386/Packages.xz -O Packages.xz
      xz -fd Packages.xz #f for multiple times
      debfilename=`grep ovideo Packages | tail -1 | grep -o '[^/]*$'`
      wget_url=https://ppa.launchpadcontent.net/colin-i/ppa/ubuntu/pool/main/o/ovideo/${debfilename}
      #https://launchpad.net/~colin-i/+archive/ubuntu/ppa/+files/${debfilename}
      wget ${wget_url} -O ovideo.deb
      #http://ro.archive.ubuntu.com/ubuntu/dists/bionic/main/binary-i386/Packages.xz
      #https://stackoverflow.com/questions/9981099/are-exported-private-keys-in-gpg-still-encrypted
      #echo -n ${{ secrets.PASS }} > pas.txt
      #echo "tag=refs/tags/1.1" >> $GITHUB_ENV
      #echo $tag ${{ env.tag }}
      ARCH=i686 ${file} ./ovideo.yml
   #- name: Create Release
   #  id: create_release
   #  uses: actions/create-release@v1
   #  env:
   #   GITHUB_TOKEN: ${{ secrets.PAT }}
   #  with:
   #   tag_name: ${{ env.tag }}
   #   release_name: Release ${{ env.tag }}
   #   draft: false
   #   rerelease: false
   #- name: Upload Release Asset
   #  uses: actions/upload-release-asset@v1
   #  env:
   #   GITHUB_TOKEN: ${{ secrets.PAT }}
   #  with:
   #   upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
   #   asset_path: ./LD-.glibc2.27-x86_64.AppImage
   #   asset_name: LD-.glibc2.27-x86_64.AppImage
   #   asset_content_type: application/x-executable
