on:
 workflow_dispatch:
env:
 #for gh and for upload
 GITHUB_TOKEN: ${{ secrets.PAT }}
jobs:
 takescreen:
  runs-on: ${{ matrix.os }}
  strategy:
   matrix:
    os: [ubuntu-22.04, ubuntu-24.04]
  steps:
   - uses: actions/checkout@master
   - name: Run a multi-line script
     run: |
      #proj
      name=`cat debian/changelog | head -1 | grep -o ^[^\ ]*`
      #get appimage artifact
      id=$(gh run list --workflow=appimage.yml -b $(git rev-parse --abbrev-ref HEAD) | cut -f7 | head -1)
      repo_at_gh=`cat debian/control | grep "^Homepage" | grep -o "[^/]*$"`
      #
      url=`gh api -H "Accept: application/vnd.github.v3+json" /repos/colin-i/${repo_at_gh}/actions/runs/${id}/artifacts | jq ".artifacts[0].archive_download_url"`
      url=${url:1:-1}
      echo ${url}
      curl -L -H "Authorization: token ${{ secrets.PAT }}" ${url} --output a.zip
      unzip ./a.zip
   - name: Install dependencies
     run: sudo apt-get install -y xvfb x11-apps imagemagick libfuse2`if [ ${{ matrix.os }} = "ubuntu-24.04" ]; then echo -n t64; fi`
     # libgtk2.0-0t64:i386 libgstreamer-plugins-base1.0-0:i386 libsoup-2.4-1:i386 libasound2t64:i386
   - name: launch and screenshot
     run: |
      export DISPLAY=:99
      sudo Xvfb :99 -screen 0 1920x1080x8 &
      sleep 5
      ./ovideo.AppImage &
      sleep 30  #10 seconds for update check
      xwd -root -silent | convert xwd:- png:screenshot.png      #xwd with x11-apps
   - name: upload artifact
     uses: actions/upload-artifact@master
     with:
      name: screenshot-${{ matrix.os }}
      path: screenshot.png
